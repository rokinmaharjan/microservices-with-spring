version: '2.1'
services:
  zookeeper:
    image: wurstmeister/zookeeper:latest
    ports:
      - 2181:2181
    networks:
      backend:
        aliases:
          - "zookeeper"
  kafkaserver:
    image: wurstmeister/kafka:latest
    ports:
      - 9092:9092
    environment:
      - KAFKA_ADVERTISED_HOST_NAME=kafka
      - KAFKA_ADVERTISED_PORT=9092
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_CREATE_TOPICS=dresses:1:1,ratings:1:1
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    depends_on:
      - zookeeper
    networks:
      backend:
        aliases:
          - "kafka"
  redisserver:
    image: redis:alpine
    ports:
      - 6379:6379
    networks:
      backend:
        aliases:
          - "redis"
  configserver:
#    image: config-server
    build: ./config-server
    ports:
      - "8071:8071"
    healthcheck:
      test: "curl --fail --silent localhost:8071/actuator/health | grep UP || exit 1"
      interval: 10s
      timeout: 5s
      retries: 2
    networks:
      backend:
        aliases:
          - "configserver"
  eurekaserver:
#    image: eureka-server
    build: ./service-discovery-eureka
    ports:
      - "8070:8070"
    environment:
      spring_cloud_config_uri: "http://configserver:8071"
    healthcheck:
      test: "curl --fail --silent localhost:8070/actuator/health | grep UP || exit 1"
      interval: 10s
      timeout: 5s
      retries: 2
    depends_on:
      configserver:
        condition: service_healthy
    networks:
      backend:
        aliases:
          - "eurekaserver"
  apigateway:
#    image: api-gateway
    build: ./api-gateway
    ports:
      - "8072:8072"
    environment:
      spring_cloud_config_uri: "http://configserver:8071"
    depends_on:
      configserver:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
    networks:
      backend:
        aliases:
          - "api-gateway"
#  microservice1:
##    image: microservice1
#    build: ./microservice1
#    environment:
#      spring_cloud_config_uri: "http://configserver:8071"
#      # eureka.client.serviceUrl.defaultZone: "http://eurekaserver:8070/eureka/"
#      server_port: "8080"
#    depends_on:
#      configserver:
#        condition: service_healthy
#      eurekaserver:
#        condition: service_healthy
#      kafkaserver:
#        condition: service_started
#    ports:
#      - "8080:8080"
#    networks:
#      - backend
  microservice2:
#    image: microservice2
    build: ./microservice2
    environment:
      spring_cloud_config_uri: "http://configserver:8071"
      # eureka_client_serviceUrl_defaultZone: "http://eurekaserver:8070/eureka/"
      server_port: "8081"
    depends_on:
      configserver:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      kafkaserver:
        condition: service_started
    ports:
      - "8081:8081"
    networks:
      - backend
#  microservice2_2:
#    image: microservice2
#    environment:
#      spring_cloud_config_uri: "http://configserver:8071"
#      # eureka_client_serviceUrl_defaultZone: "http://eurekaserver:8070/eureka/"
#      server_port: "8083"
#    depends_on:
#      configserver:
#        condition: service_healthy
#      eurekaserver:
#        condition: service_healthy
#    ports:
#      - "8083:8083"
#    networks:
#      - backend
  microservice3:
#    image: microservice3
    build: ./microservice3
    environment:
      spring_cloud_config_uri: "http://configserver:8071"
      # eureka_client_serviceUrl_defaultZone: "http://eurekaserver:8070/eureka/"
      server_port: "8082"
    depends_on:
      configserver:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      kafkaserver:
        condition: service_started
    ports:
      - "8082:8082"
    networks:
      - backend
#  microservice3_2:
#    image: microservice3
#    environment:
#      spring_cloud_config_uri: "http://configserver:8071"
#      # eureka_client_serviceUrl_defaultZone: "http://eurekaserver:8070/eureka/"
#      server_port: "8084"
#    depends_on:
#      configserver:
#        condition: service_healthy
#      eurekaserver:
#        condition: service_healthy
#    ports:
#      - "8084:8084"
#    networks:
#      - backend

networks:
  backend:
    driver: bridge